<% content_for(:title, "#{@plan.title} の持ち物チェックリスト") %>

<div class="min-h-screen bg-gray-100 px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">
    <%= @plan.title %> の持ち物チェックリスト
  </h1>

  <% if flash[:alert] %>
    <div class="alert alert-danger mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
      <div class="flex items-center">
        <span class="text-red-500 mr-2">⚠️</span>
        <%= flash[:alert] %>
      </div>
    </div>
  <% end %>

  <% if flash[:notice] %>
    <div class="alert alert-success mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
      <div class="flex items-center">
        <span class="text-green-500 mr-2">✅</span>
        <%= flash[:notice] %>
      </div>
    </div>
  <% end %>

  <!-- タブ切り替え -->
  <div class="flex justify-center mb-6">
    <div class="bg-white rounded-lg shadow p-1 flex">
      <%= link_to plan_checklist_items_path(@plan, item_type: 'shared'),
          class: "px-6 py-2 rounded-md transition-colors #{'bg-blue-500 text-white' if @item_type == 'shared'} #{'text-gray-600 hover:text-blue-500' if @item_type != 'shared'}" do %>
        📋 共有
      <% end %>
      
      <%= link_to plan_checklist_items_path(@plan, item_type: 'personal'),
          class: "px-6 py-2 rounded-md transition-colors #{'bg-blue-500 text-white' if @item_type == 'personal'} #{'text-gray-600 hover:text-blue-500' if @item_type != 'personal'}" do %>
        👤 個人
      <% end %>
    </div>
  </div>

  <div class="max-w-4xl mx-auto">
    <!-- タブの説明 -->
    <div class="text-center text-gray-600 mb-6">
      <% if @item_type == 'shared' %>
        <p>🌟 みんなで共有する持ち物リスト</p>
      <% else %>
        <p>👤 あなた専用の持ち物リスト</p>
      <% end %>
    </div>

    <% if @item_type == 'shared' %>
      <!-- 共有タブ：新規追加フォーム -->
      <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">新しい共有アイテムを追加</h3>
        
        <%= form_with model: [@plan, ChecklistItem.new], local: true do |form| %>
          <div class="space-y-4">
            <div>
              <%= form.text_field :name, 
                  placeholder: "新しいアイテムを入力...", 
                  class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
            </div>
            
            <div class="flex gap-3 items-center">
              <label class="text-sm font-medium text-gray-700">担当者:</label>
              <%= form.select :assignee_id, 
                  options_from_collection_for_select(@plan.participants, :id, :name), 
                  { prompt: "担当者を選択..." },
                  { class: "px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" } %>
              
              <%= form.hidden_field :is_shared, value: true %>
              <%= form.submit "追加", class: "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 共有タブ：プランメンバーごとにグループ化して表示 -->
      <% @grouped_items.each do |group| %>
        <div class="bg-white rounded-xl shadow p-6 mb-6">
          <!-- ユーザー名のヘッダー部分 -->
          <div class="flex items-center mb-4 pb-3 border-b border-gray-200">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
              <%= group[:user].name.first %>
            </div>
            
            <h2 class="text-xl font-bold text-gray-800">
              <%= group[:user].name %>の担当アイテム
              <% if group[:is_current_user] %>
                <span class="text-sm font-normal text-blue-600">（あなた）</span>
              <% end %>
            </h2>
            
            <span class="ml-auto text-sm text-gray-500">
              <%= group[:items].count %>個のアイテム
            </span>
          </div>

          <!-- そのユーザーのアイテム一覧 -->
          <% if group[:items].any? %>
            <div class="space-y-3">
              <% group[:items].each do |item| %>
                <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg">
                  <div class="flex items-center space-x-3">
                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                      <%= form_with model: [@plan, item], local: false, class: "inline-block" do |f| %>
                        <%= f.check_box :checked,
                              onchange: "this.form.submit()",
                              class: "w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer" %>
                      <% end %>
                      <span class="text-blue-600 text-sm"></span>
                    </div>
                    
                    <span class="text-gray-800 text-lg font-medium">
                      <%= item.name %>
                    </span>
                  </div>
                  
                  <% if @plan.user == current_user %>
                    <%= link_to plan_checklist_item_path(@plan, item, item_type: @item_type), 
                        method: :delete,
                        confirm: "本当に削除しますか？",
                        class: "text-red-500 text-sm hover:text-red-700 px-3 py-1 rounded hover:bg-red-50 transition-colors" do %>
                      🗑️ 削除
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-8">
              <div class="text-gray-400 text-4xl mb-3">📦</div>
              <p class="text-gray-500 text-lg">まだ担当アイテムがありません</p>
              <p class="text-gray-400 text-sm mt-1">上のフォームから新しいアイテムを追加してみましょう！</p>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <!-- 個人タブの実装 -->
      <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">新しい個人アイテムを追加</h3>
        
        <%= form_with model: [@plan, ChecklistItem.new], local: true do |form| %>
          <div class="flex gap-3">
            <%= form.text_field :name, 
                placeholder: "新しいアイテムを入力...", 
                class: "flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
            <%= form.hidden_field :is_shared, value: false %>
            <%= form.submit "追加", class: "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" %>
          </div>
        <% end %>
      </div>

      <!-- 個人アイテム一覧の表示 -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center mb-4 pb-3 border-b border-gray-200">
          <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
            <%= current_user.name.first %>
          </div>
          
          <h3 class="text-xl font-bold text-gray-800">
            あなたの個人アイテム
          </h3>
          
          <span class="ml-auto text-sm text-gray-500">
            <%= @personal_items&.count || 0 %>個のアイテム
          </span>
        </div>
        
        <% if @personal_items&.any? %>
          <div class="space-y-3">
            <% @personal_items.each do |item| %>
              <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <%= form_with model: [@plan, item],
                                url: plan_checklist_item_path(@plan, item, item_type: params[:item_type]), 
                                local: true,
                                class: "inline-block" do |f| %>
                    <%= f.hidden_field :item_type, value: item.item_type %>
                    <%= f.check_box :checked,
                          onchange: "this.form.submit()",
                          class: "w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer" %>
                  <% end %>

                  <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                    <span class="text-green-600 text-sm"></span>
                  </div>
                  
                  <span class="text-gray-800 text-lg font-medium">
                    <%= item.name %>
                  </span>
                </div>
                
                <%= link_to plan_checklist_item_path(@plan, item, item_type: @item_type), 
                    method: :delete,
                    confirm: "本当に削除しますか？",
                    class: "text-red-500 text-sm hover:text-red-700 px-3 py-1 rounded hover:bg-red-50 transition-colors" do %>
                  🗑️削除
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8">
            <div class="text-gray-400 text-4xl mb-3">📝</div>
            <p class="text-gray-500 text-lg">まだ個人アイテムがありません</p>
            <p class="text-gray-400 text-sm mt-1">上のフォームから新しいアイテムを追加してみましょう！</p>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- 戻るボタン -->
    <div class="text-center mt-8">
      <%= link_to plan_path(@plan), 
          class: "inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" do %>
        ← プランに戻る
      <% end %>
    </div>
  </div>
</div>
