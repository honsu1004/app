<div class="min-h-screen bg-gray-100 relative px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-8"><%= @plan.title %> のスケジュール</h1>

  <% grouped_items = @schedule_items.group_by(&:day_number) %>

  <% grouped_items.sort_by { |day, _| day.to_i }.each do |day, items| %>
    <div class="mb-8 day-container" data-day-number="<%= day %>">
      <h2 class="text-xl font-semibold text-blue-600 mb-4">📅 <%= day %>日目</h2>

      <div class="space-y-4">
        <% if items.present? %>
          <!-- ここを修正：sort_items_by_time(items) を items に変更 -->
          <% items.each_with_index do |item, index| %>
            <div class="bg-white rounded-xl shadow p-4 schedule-item cursor-pointer hover:shadow-lg transition-shadow duration-200" 
                 data-item-id="<%= item.id %>" 
                 data-position="<%= index + 1 %>"
                 onclick="location.href='<%= plan_schedule_item_path(@plan, item) %>'">

              <!-- 全体をflexコンテナにして、左右に明確に分ける -->
              <div class="flex items-start justify-between w-full">
              
                <!-- 左側：メインコンテンツ -->
                <div class="flex-1 min-w-0">
                  <!-- 場所名 -->
                  <% if item.url.present? %>
                    <p class="text-gray-800 font-semibold">
                      📍 <%= link_to item.location_name, item.url, 
                              target: "_blank", 
                              rel: "noopener noreferrer",
                              class: "text-blue-600 hover:text-blue-800 hover:underline",
                              onclick: "event.stopPropagation()" %>
                    </p>
                  <% else %>
                    <p class="text-gray-800 font-semibold">📍 <%= item.location_name %></p>
                  <% end %>
        
                  <!-- 時間表示 -->
                  <% if item.start_time.present? %>
                    <p class="text-sm text-gray-600 mt-1">
                      🕒 <%= item.start_time.strftime("%H:%M") %>
                      <% if item.end_time.present? %>
                          〜<%= item.end_time.strftime("%H:%M") %>
                      <% end %>
                    </p>
                  <% else %>
                    <p class="text-sm text-gray-600 mt-1">🕒 時間未設定</p>
                  <% end %>
        
                  <!-- メモ -->
                  <% if item.memo.present? %>
                    <p class="text-xs text-gray-500 mt-1 truncate">📝 <%= item.memo %></p>
                  <% end %>
                </div>
      
                <!-- 右側：編集ボタン（ボックスの右端に固定） -->
                <div class="flex items-center ml-6 flex-shrink-0">
                  <%= link_to "編集", edit_plan_schedule_item_path(@plan, item), 
                      class: "inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100 hover:border-blue-300 transition-all duration-200",
                      onclick: "event.stopPropagation()" %>
                </div>
      
              </div>
            </div>
          <% end %>
        
        <!-- 空の状態表示 -->
        <% else %>
          <div class="bg-gray-50 rounded-xl p-8 text-center border-2 border-dashed border-gray-300">
            <p class="text-gray-500">この日のスケジュールはまだありません</p>
            <%= link_to "最初のスケジュールを追加", 
                new_plan_schedule_item_path(@plan, day_number: day),
                class: "text-blue-500 hover:underline text-sm mt-2 inline-block" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- 右下の「＋スケジュール追加」ボタン -->
  <div class="fixed bottom-6 right-6">
    <%= link_to new_plan_schedule_item_path(@plan),
                class: "bg-blue-500 hover:bg-blue-600 text-white text-lg font-bold py-3 px-5 rounded-full shadow-lg transition-all duration-200 hover:shadow-xl" do %>
      <span class="text-xl">＋</span> スケジュール追加
    <% end %>
  </div>
  
  <!-- 戻るボタン -->
  <div class="mt-8 text-center pb-20">
    <%= link_to "プランに戻る", plan_path(@plan), 
        class: "inline-flex items-center px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 hover:underline transition-colors" %>
  </div>
</div>
