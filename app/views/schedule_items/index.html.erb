<div class="min-h-screen bg-gray-100 relative px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-8"><%= @plan.title %> ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>

  <% grouped_items = @schedule_items.group_by(&:day_number).sort_by { |day, _| day.to_i }.to_h %>

  <% grouped_items.each do |day, items| %>
    <div class="mb-8 day-container" data-day-number="<%= day %>">
      <h2 class="text-xl font-semibold text-blue-600 mb-4">ğŸ“… <%= day %>æ—¥ç›®</h2>

      <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œã®ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="space-y-4 sortable-container" id="sortable-day-<%= day %>">
        <!-- ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã®è¡¨ç¤º -->
        <% if items.present? %>
          <% items.sort_by(&:position).each do |item| %>
            <div class="bg-white rounded-xl shadow p-4 schedule-item cursor-move" 
                 data-item-id="<%= item.id %>" 
                 data-position="<%= item.position %>">

              <!-- å…¨ä½“ã‚’flexã‚³ãƒ³ãƒ†ãƒŠã«ã—ã¦ã€å·¦å³ã«æ˜ç¢ºã«åˆ†ã‘ã‚‹ -->
              <div class="flex items-start justify-between w-full">
              
                <!-- å·¦å´ï¼šãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="flex items-start flex-1 min-w-0">
                  <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
                  <div class="drag-handle mr-3 mt-1 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing flex-shrink-0"
                    style="touch-action: none;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <circle cx="3" cy="3" r="1"/>
                      <circle cx="3" cy="8" r="1"/>
                      <circle cx="3" cy="13" r="1"/>
                      <circle cx="8" cy="3" r="1"/>
                      <circle cx="8" cy="8" r="1"/>
                      <circle cx="8" cy="13" r="1"/>
                    </svg>
                  </div>  
                
                  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                  <div class="flex-1 min-w-0">
                    <!-- å ´æ‰€åï¼ˆURLãŒã‚ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ -->
                    <% if item.url.present? %>
                      <p class="text-gray-800 font-semibold">
                        ğŸ“ <%= link_to item.location_name, item.url, 
                                target: "_blank", 
                                rel: "noopener noreferrer", 
                                class: "text-blue-600 hover:text-blue-800 hover:underline" %>
                      </p>
                    <% else %>
                      <p class="text-gray-800 font-semibold">ğŸ“ <%= item.location_name %></p>
                    <% end %>
          
                    <!-- æ™‚é–“è¡¨ç¤º -->
                    <% if item.start_time.present? %>
                      <p class="text-sm text-gray-600 mt-1">
                        ğŸ•’ <%= item.start_time.strftime("%H:%M") %>
                        <% if item.end_time.present? %>
                            ã€œ<%= item.end_time.strftime("%H:%M") %>
                        <% end %>
                      </p>
                    <% else %>
                      <p class="text-sm text-gray-600 mt-1">ğŸ•’ æ™‚é–“æœªè¨­å®š</p>
                    <% end %>
          
                    <!-- ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º -->
                    <% if item.memo.present? %>
                      <p class="text-xs text-gray-500 mt-1 truncate">ğŸ“ <%= item.memo %></p>
                    <% end %>
                  </div>
                </div>
      
                <!-- å³å´ï¼šç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆãƒœãƒƒã‚¯ã‚¹ã®å³ç«¯ã«å›ºå®šï¼‰ -->
                <div class="flex items-center ml-6 flex-shrink-0">
                  <%= link_to "ç·¨é›†", edit_plan_schedule_item_path(@plan, item), 
                      class: "inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100 hover:border-blue-300 transition-all duration-200" %>
                </div>
      
              </div>
            </div>
          <% end %> <!-- items.each ã®end -->
        
        <!-- ç©ºã®çŠ¶æ…‹è¡¨ç¤º -->
        <% else %>
          <div class="bg-gray-50 rounded-xl p-8 text-center border-2 border-dashed border-gray-300">
            <p class="text-gray-500">ã“ã®æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
            <%= link_to "æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ", 
                new_plan_schedule_item_path(@plan, day_number: day),
                class: "text-blue-500 hover:underline text-sm mt-2 inline-block" %>
          </div>
        <% end %> <!-- if items.present? ã®end -->
      </div>
    </div>
  <% end %> <!-- grouped_items.each ã®end -->
</div>


  <!-- å³ä¸‹ã®ã€Œï¼‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã€ãƒœã‚¿ãƒ³ -->
  <div class="fixed bottom-6 right-6">
    <%= link_to new_plan_schedule_item_path(@plan),
                class: "bg-blue-500 hover:bg-blue-600 text-white text-lg font-bold py-3 px-5 rounded-full shadow-lg transition-all duration-200 hover:shadow-xl" do %>
      <span class="text-xl">ï¼‹</span> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 
    <% end %>
  </div>
  
  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ãªã—ï¼‰ -->
  <div class="mt-8 text-center pb-20">
    <%= link_to "ãƒ—ãƒ©ãƒ³ã«æˆ»ã‚‹", plan_path(@plan), 
        class: "inline-flex items-center px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 hover:underline transition-colors" %>
  </div>
</div>

<style>
  .sortable-ghost {
    opacity: 0.4;
    background: #f3f4f6;
    transform: scale(0.98);
  }
  
  .sortable-chosen {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    transform: scale(1.02);
    z-index: 1000;
  }
  
  .sortable-drag {
    opacity: 0.8;
    transform: rotate(2deg);
  }
  
  .drag-handle:hover {
    background-color: #f9fafb;
    border-radius: 4px;
  }
  
  .schedule-item {
    transition: all 0.2s ease;
  }
  
  .schedule-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }
  
  /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .sortable-container {
    min-height: 60px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
  }
  
  .sortable-container.drag-over {
    background-color: #eff6ff;
    border: 2px dashed #3b82f6;
  }
</style>

<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const planId = <%= @plan.id %>;
  
  // å„æ—¥ã®ã‚³ãƒ³ãƒ†ãƒŠã«Sortableã‚’é©ç”¨
  document.querySelectorAll('.sortable-container').forEach(container => {
    new Sortable(container, {
      group: 'schedule-items', // ç•°ãªã‚‹æ—¥é–“ã§ã®ç§»å‹•ã‚’å¯èƒ½ã«ã™ã‚‹
      animation: 200,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      handle: '.drag-handle', // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’æŒ‡å®š
      
      // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚
      onStart: function(evt) {
        document.body.classList.add('dragging');
        evt.item.classList.add('dragging-item');
      },
      
      // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚
      onEnd: function(evt) {
        document.body.classList.remove('dragging');
        evt.item.classList.remove('dragging-item');
        
        // ä½ç½®ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°
        if (evt.oldIndex !== evt.newIndex || evt.from !== evt.to) {
          updatePositions();
        }
      },
      
      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã«å…¥ã£ãŸæ™‚
      onMove: function(evt) {
        const related = evt.related;
        const dragged = evt.dragged;
        
        // ç‰¹å®šã®æ¡ä»¶ã§ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ç¦æ­¢ã™ã‚‹å ´åˆ
        // return false;
      }
    });
  });
  
  // ä½ç½®æ›´æ–°é–¢æ•°
  function updatePositions() {
    const positions = [];
    
    document.querySelectorAll('.day-container').forEach(dayContainer => {
      const dayNumber = dayContainer.dataset.dayNumber;
      const items = dayContainer.querySelectorAll('.schedule-item');
      
      items.forEach((item, index) => {
        positions.push({
          id: parseInt(item.dataset.itemId),
          position: index + 1,
          day_number: parseInt(dayNumber)
        });
      });
    });
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch(`/plans/${planId}/schedule_items/update_positions`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: JSON.stringify({ positions: positions })
    })
    .then(response => {
      if (response.ok) {
        // æˆåŠŸæ™‚ã®å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        showNotification('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é †åºã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } else {
        throw new Error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      setTimeout(() => location.reload(), 1000);
    });
  }
  
  // é€šçŸ¥è¡¨ç¤ºé–¢æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
      type === 'success' ? 'bg-green-500' : 
      type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 3ç§’å¾Œã«å‰Šé™¤
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});
</script>
